pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
debug_window={}
function debug_window:init()
	debug_log={}
end
function debug_window:draw()
	rectfill(0,0,100,100,7)
	cursor(1,1,5)
	for i=1,#debug_log do
		print(debug_log[i])
	end
	debug_log={}
end

function log(s)
	add(debug_log,s)
end

blank_window={}
function blank_window:init()
	self.c=11
end
function blank_window:draw()
	rectfill(0,0,100,100,self.c)
end
function blank_window:onclick(x,y)
	self.c+=1
end

function create_window(class,x,y)
	local newwin={x=x,y=y,class=class,data={}}
	add(windows,newwin)
	newwin.class.init(newwin.data)
end

function _init()
	poke(0x5f2d,1)
	windows={}
	create_window(debug_window,10,10)
	create_window(blank_window,50,16)
	create_window(blank_window,60,26)
end

function get_mouse_target()
	for i=#windows,1,-1 do
		local w=windows[i]
		local inx=mousex>=w.x and mousex<=w.x+24
		local iny=mousey>=w.y and mousey<=w.y+24
		if iny and inx then
			return i
		end
	end
	return -1
end

function _update()
	mousex=stat(32)
	mousey=stat(33)
	local new_mousebtns=stat(34)
	local ldown=band(new_mousebtns,1)
	local ldown_last=band(mousebtns,1)
	local lpressed=ldown~=0 and ldown_last==0
	local lreleased=ldown==0 and ldown_last~=0
	mousebtns=new_mousebtns
	
	local mouse_target=get_mouse_target()
	
	if lpressed and mouse_target~=-1 then
		local w=windows[mouse_target]
		del(windows,w)
		add(windows,w)
		
		if mousey-w.y<=4 and mousex-w.x<=20 then
			dragging=true
			dragx=mousex
			dragy=mousey
			dragw=#windows
		end
	end
	
	if dragging then
		local w=windows[dragw]
		w.x=mid(0,w.x+mousex-dragx,104)
		w.y=mid(0,w.y+mousey-dragy,96)
		dragx=mousex
		dragy=mousey
	end
	
	if not dragging and lreleased and mouse_target~=-1 then
		local w=windows[mouse_target]
		local lx=mousex-w.x
		local ly=mousey-w.y
		if lx>=20 and ly<=4 then
			--close button
			del(windows,w)
		end
		if w.class.onclick and ly>=5 and ly<24 then
			w.class.onclick(w.data,lx-1,ly-4)
		end
	end
	
	if lreleased then
		dragging=false
	end
end

function draw_windows()
	for i=1,#windows do
		window=windows[i]
		camera()
		clip()
		spr(4,window.x,window.y,3,3)
		clip(window.x+1,window.y+4,22,19)
		camera(-window.x-1,-window.y-4)
		window.class.draw(window.data)
	end
	camera()
	clip()
end

function draw_os_chrome()
	sspr(16,0,8,8,0,120,128,8)
	spr(1,0,121)
	local h=""..stat(93)
	if (#h==1) h="0"..h
	local m=""..stat(94)
	if (#m==1) m="0"..m
	print(h..":"..m,108,122,5)
end

function draw_mouse()
	spr(3,mousex,mousey)
end

function _draw()
	cls()
	draw_windows()
	draw_os_chrome()
	draw_mouse()
end
__gfx__
00000000000500008888888855550000055555555555555555555550000000000000000000000000000000000000000000000000000000000000000000000000
000000000058500077777777577750005eeeeeeeeeeeeeeeeeee8e85000000000000000000000000000000000000000000000000000000000000000000000000
007007000597f500eeeeeeee577750005eeeeeeeeeeeeeeeeeeee8e5000000000000000000000000000000000000000000000000000000000000000000000000
000770005a777e50eeeeeeee577750005eeeeeeeeeeeeeeeeeee8e85000000000000000000000000000000000000000000000000000000000000000000000000
0007700005b7d500eeeeeeee05557500500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00700700005c5000eeeeeeee00005750500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
0000000000050000eeeeeeee00000575500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000008888888800000055500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000500000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000055555555555555555555550000000000000000000000000000000000000000000000000000000000000000000000000
